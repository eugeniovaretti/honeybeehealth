---
title: "Final GAM"
output: html_notebook
---
```{r message=FALSE, warning=FALSE, echo=FALSE}
#if not installed install all the following libraries
library(tseries)
library(visdat)
library(raster)
library(ggplot2)
library(gridExtra)
library(forecast)
library(svglite)
library(roahd)
  
library(mgcv)
library(rgl)
library(splines)
library(pbapply)
library(lattice)
library(maps)

```


```{r}
###GAM###
df <- read.csv("../../data/new_data/data_bystate_temp_perc.csv")
df_coord <- read.csv("../../data/state_coords_lon_lat.csv")

df_st <- df[df$state != "hawaii" & df$state != "other states",]
df_coord <- df_coord[df_coord$state != "hawaii" & df_coord$state != "other states",]

df_new <- merge(df_st, df_coord, by = "state")
df_new <- df_new %>% arrange(state, year, months)
df_new$year <- factor(df_new$year)
df_new$months <- factor(df_new$months)

locations <- unique(df_new$state)

# aggiungo missing data for 2019,Q2
row2019Q2 <- df_new[seq(1,length(locations)),]
row2019Q2[,1] <- locations
row2019Q2[,2] <- "2019"
row2019Q2[,3] <- "Q2"

row2019Q2[,-c(1,2,3)] <- NA


df_new_comp <- rbind(df_new,row2019Q2)
df_new_comp <- df_new_comp %>% arrange(state, year, months)
df_new_comp$state <- factor(df_new_comp$state)

timet <- rep(1:30, 44)
df_new_comp$timet <- timet
```

A good starting point for our model is:
$$
Losses_{state,time} = \alpha_{state} + \beta\times Varroa_{state,time} + f_{state}(time_{time}) +  \epsilon_{state,time}
$$
where $Losses_{is}$ is the vale of time series $i = 1,..., 40$ in time $s = 1, ..., 30$, where $f_i(time_s)$ is a smoother for time in each state. If we remove the index $i$ we assume the same smoother for each state, hence the time series are assumed to follow the same trend.

```{r}
#attach(df_new_comp)
df_new_comp$colony_survived <- df_new_comp$colony_max - df_new_comp$colony_lost
#df_new_comp1<-df_new_comp[seq(1,60),]
col_ratio <- with(df_new_comp,colony_lost/colony_max)
with(df_new_comp,xyplot(col_ratio ~ timet | state, col = 1)) #fallo in console con x11();with(df_new_comp,xyplot(col_ratio ~ timet | state, col = 1))
```
From the above plot we notice that some states have considerably more variation, indicating violation of homogeneity.
The solution is to allow for different spread per time-series.  
Since the data for each state are time-series assumption of indipendence may be violated, so we implement a residual auto-correlation structure. (we choose an AR1 (see the gam_clean.Rmd for this analysis))
$$
\epsilon_{i,s} = \rho \times \epsilon_{i,s-1} + \eta_{is}
$$

```{r}
#df_new_comp1$state <- factor(df_new_comp1$state)
df_new_comp[which(df_new_comp$Disesases>50),]

gamm1 <- gamm(cbind(colony_lost,colony_survived) ~ 
               s(Varroa.mites) + s(Disesases)+ s(I(MinimumTemperature+273))
              + s(Pesticides) #+ s(Other) + s(Unknown) 
              #+ s(Other.pests.parasites)
              #+ s(Precipitation)
              #+ s(lon,lat)
              + state #R^2 meglio qua 
              + s(timet, bs="cc")
              ,correlation = corAR1(form =~ timet | state )
              , weights = varIdent(form =~ 1 | state)
              ,na.action = na.omit
              ,family = binomial(link = "logit")
              ,data = df_new_comp)
summary(gamm1$gam)
plot(gamm1$gam)
```

The reisduals look fine!
```{r}
plot(gamm1$gam$residuals)
#plot(x=df_new_comp[which(df_new_comp$months == "Q1"),]$MinimumTemperature, y=df_new_comp[which(df_new_comp$months == "Q1"),]$colony_lost_pct)
```

```{r}
#best <- c(1, 1, 1, 2, 1, 2, 2, 2, 1, 3, 1, 1, 1, 2, 1, 1,2, 1, 1, 2, 1, 1, 2, 1, 2, 1, 2, 1, 2, 1, 1, 2, 2, 1, 1, 1, 3, 1, 1, 2, 1, 1, 2, 2)
best <- c(1, 1, 1, 2, 1, 2, 2, 2, 1, 1, 1, 1, 1, 2, 1, 1,2, 1, 1, 2, 1, 1, 2, 1, 2, 1, 2, 1, 2, 1, 1, 2, 2, 1, 1, 1, 1, 1, 1, 2, 1, 1, 2, 2)

vclus <- factor(rep(best,each=30))
Z <- df_new_comp[,c(1,6,9,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25)]
Z$vclus <- vclus
gamm2 <- gamm(cbind(colony_lost,colony_survived) ~ 
                                                        
        + s(Varroa.mites, by=vclus )
  +Other.pests.parasites+                         
  +Pesticides            +         Other                         
+ Unknown                 +       MaximumTemperature            
 +MinimumTemperature       +      PalmerDroughtSeverityIndexPDSI
 +Precipitation             +     #AverageTemperature non sign     
 +state                          
 +s(timet)                        
              ,correlation = corAR1(form =~ timet | state)
              ,na.action = na.omit
              ,family = binomial(link = "logit")
              , data = Z)
summary(gamm2$gam)
plot(gamm2$gam)
```
The best cluster on Varroa induced by the BNP clustering is:
1 1 1 2 1 2 2 2 1 3 1 1 1 2 1 1 2 1 1 2 1 1 2 1 2 1 2 1 2 1 1 2 2 1 1 1 3 1 1 2 1 1 2 2
```{r}
amm2 <- gamm(colony_lost~ 
        vclus                             
        + s(Varroa.mites, by = as.numeric(vclus=="1") )
        + s(Varroa.mites, by = as.numeric(vclus=="2") )
  +Other.pests.parasites+                         
  +Pesticides            +         Other                         
+ Unknown                 +       MaximumTemperature            
 +MinimumTemperature       +      PalmerDroughtSeverityIndexPDSI
 +Precipitation             +     #AverageTemperature non sign     
 +state                          
 +s(timet)                        
              ,correlation = corAR1(form =~ timet | state)
              ,na.action = na.omit
              
              , data = Z)
```

```{r}


gamm0 <- gamm(cbind(colony_lost,colony_survived) ~  
                Varroa.mites +
                s(time, by = as.numeric(state == "alabama"))+
                s(time, by = as.numeric(state == "arizona"))+
                s(time, by = as.numeric(state == "arkansas"))+
                s(time, by = as.numeric(state == "california"))+
                s(time, by = as.numeric(state == "colorado"))+
                s(time, by = as.numeric(state == "connecticut"))+
                s(time, by = as.numeric(state == "florida"))+
                s(time, by = as.numeric(state == "georgia"))+
                s(time, by = as.numeric(state == "idaho"))+
                s(time, by = as.numeric(state == "illinois"))+
                s(time, by = as.numeric(state == "indiana"))+
                s(time, by = as.numeric(state == "iowa"))+
                s(time, by = as.numeric(state == "kansas"))+
                s(time, by = as.numeric(state == "kentucky"))+
                s(time, by = as.numeric(state == "louisiana"))+
                s(time, by = as.numeric(state == "maine"))+
                s(time, by = as.numeric(state == "maryland"))+
                s(time, by = as.numeric(state == "massachusetts"))+
                s(time, by = as.numeric(state == "michigan"))+
                s(time, by = as.numeric(state == "minnesota"))+
                s(time, by = as.numeric(state == "mississippi"))+
                s(time, by = as.numeric(state == "missouri"))+
                s(time, by = as.numeric(state == "montana"))+
                s(time, by = as.numeric(state == "nebraska"))+
                s(time, by = as.numeric(state == "new jersey"))+
                s(time, by = as.numeric(state == "new mexico"))+
                s(time, by = as.numeric(state == "new york"))+
                s(time, by = as.numeric(state == "north carolina"))+
                s(time, by = as.numeric(state == "north dakota"))+
                s(time, by = as.numeric(state == "ohio"))+
                s(time, by = as.numeric(state == "oklahoma"))+
                s(time, by = as.numeric(state == "oregon"))+
                s(time, by = as.numeric(state == "pennsylvania"))+
                s(time, by = as.numeric(state == "sout carolina"))+
                s(time, by = as.numeric(state == "south dakota"))+
                s(time, by = as.numeric(state == "tennessee"))+
                s(time, by = as.numeric(state == "texas"))+
                s(time, by = as.numeric(state == "utah"))+
                s(time, by = as.numeric(state == "vermont"))+
                s(time, by = as.numeric(state == "virginia"))+
                s(time, by = as.numeric(state == "washington"))+
                s(time, by = as.numeric(state == "west virginia"))+
                s(time, by = as.numeric(state == "wisconsin"))+
                s(time, by = as.numeric(state == "wyoming"))

                
              ,na.action = na.omit
              ,family = binomial(link = "logit")
              , data = df_new_comp)

E <- residuals(gamm1$gam, type = "deviance")
I1 <- !is.na(df_new_comp$colony_lost)
 Efull <- vector(length = length(df_new_comp$colony_lost))
 Efull <- NA
 Efull[I1] <- E
acf(Efull, na.action = na.pass,
main = "Auto-correlation plot for residuals")
```
